#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Script de prueba para validar la extracci√≥n de extensi√≥n espacial post-creaci√≥n de RECURSOS.

Este script prueba que la nueva funcionalidad de extracci√≥n de extensi√≥n espacial
funciona correctamente despu√©s de crear o actualizar un RECURSO (usando IResourceController),
especialmente para archivos ZIP que se marcan con formato "SHP".
"""

import sys
import os
import tempfile
import json

# Add project directory to path
project_dir = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, project_dir)

def test_is_potential_spatial_resource():
    """Prueba la funci√≥n _is_potential_spatial_resource del SchemingDCATDatasetsPlugin"""
    print("üß™ Probando _is_potential_spatial_resource...")
    
    # Import the plugin
    from ckanext.schemingdcat.plugin import SchemingDCATDatasetsPlugin
    
    plugin = SchemingDCATDatasetsPlugin()
    
    # Test cases - IMPORTANTE: Los ZIP se marcan como formato "SHP"
    test_resources = [
        {'format': 'SHP', 'url': 'http://example.com/shapefile.zip', 'expected': True, 'description': 'ZIP con formato SHP'},
        {'format': 'SHP', 'url': 'http://example.com/boundaries.shp', 'expected': True, 'description': 'Shapefile directo'},
        {'format': 'CSV', 'url': 'http://example.com/data.csv', 'expected': False, 'description': 'CSV normal'},
        {'format': 'PDF', 'url': 'http://example.com/doc.pdf', 'expected': False, 'description': 'PDF normal'},
        {'format': '', 'url': 'http://example.com/data.zip', 'expected': True, 'description': 'ZIP detectado por extensi√≥n'},
        {'format': '', 'url': 'http://example.com/data.geojson', 'expected': True, 'description': 'GeoJSON por extensi√≥n'},
        {'format': 'TIF', 'url': 'http://example.com/raster.tif', 'expected': True, 'description': 'GeoTIFF'},
        {'format': 'GEOJSON', 'url': 'http://example.com/boundaries.geojson', 'expected': True, 'description': 'GeoJSON'},
    ]
    
    all_passed = True
    for i, test_case in enumerate(test_resources):
        expected = test_case.pop('expected')
        description = test_case.pop('description')
        result = plugin._is_potential_spatial_resource(test_case)
        status = "‚úÖ" if result == expected else "‚ùå"
        print(f"  {status} Test {i+1}: {description}")
        print(f"       format='{test_case.get('format', '')}', url='{test_case['url']}' -> {result} (expected: {expected})")
        if result != expected:
            all_passed = False
    
    print(f"üéØ Resultado: {'Todas las pruebas pasaron' if all_passed else 'Algunas pruebas fallaron'}")
    return all_passed

def test_spatial_extent_module_availability():
    """Prueba que el m√≥dulo de extensi√≥n espacial est√© disponible"""
    print("\nüß™ Probando disponibilidad del m√≥dulo de extensi√≥n espacial...")
    
    try:
        from ckanext.schemingdcat.spatial_extent import extent_extractor
        print("  ‚úÖ M√≥dulo de extensi√≥n espacial disponible")
        
        # Test basic functionality
        spatial_extensions = extent_extractor.SUPPORTED_EXTENSIONS
        print(f"  üìã Extensiones soportadas: {list(spatial_extensions.keys())}")
        
        # Test ZIP shapefile support
        zip_supported = 'zip' in spatial_extensions
        print(f"  üì¶ Soporte para ZIP: {'‚úÖ' if zip_supported else '‚ùå'}")
        
        return True
    except ImportError as e:
        print(f"  ‚ùå M√≥dulo no disponible: {e}")
        return False

def test_resource_controller_integration():
    """Prueba la integraci√≥n con SchemingDCATDatasetsPlugin (IResourceController)"""
    print("\nüß™ Probando integraci√≥n con IResourceController...")
    
    try:
        from ckanext.schemingdcat.plugin import SchemingDCATDatasetsPlugin
        
        plugin = SchemingDCATDatasetsPlugin()
        
        # Test that the new methods exist
        methods_to_check = [
            '_process_spatial_extent_extraction_for_resource',
            '_is_potential_spatial_resource', 
            '_extract_spatial_extent_from_resource',
            '_update_dataset_spatial_extent',
            'after_create',  # IResourceController hook
            'after_update'   # IResourceController hook
        ]
        
        all_methods_exist = True
        for method_name in methods_to_check:
            if hasattr(plugin, method_name):
                print(f"  ‚úÖ M√©todo {method_name} existe")
            else:
                print(f"  ‚ùå M√©todo {method_name} no existe")
                all_methods_exist = False
        
        return all_methods_exist
        
    except ImportError as e:
        print(f"  ‚ùå Error importando SchemingDCATDatasetsPlugin: {e}")
        return False

def test_mock_resource_processing():
    """Simula el procesamiento de recursos espaciales individuales"""
    print("\nüß™ Simulando procesamiento de recursos espaciales individuales...")
    
    try:
        from ckanext.schemingdcat.plugin import SchemingDCATDatasetsPlugin
        
        plugin = SchemingDCATDatasetsPlugin()
        
        # Mock resources - casos t√≠picos
        mock_resources = [
            {
                'id': 'resource-zip-shp',
                'format': 'SHP',  # CLAVE: ZIP se marca como SHP
                'url': 'https://example.com/boundaries.zip',
                'package_id': 'dataset-123'
            },
            {
                'id': 'resource-geotiff',
                'format': 'TIF',
                'url': 'https://example.com/elevation.tif',
                'package_id': 'dataset-456'
            },
            {
                'id': 'resource-csv',
                'format': 'CSV',
                'url': 'https://example.com/data.csv',
                'package_id': 'dataset-789'
            },
            {
                'id': 'resource-geojson',
                'format': 'GEOJSON',
                'url': 'https://example.com/areas.geojson',
                'package_id': 'dataset-abc'
            }
        ]
        
        # Test resource filtering
        spatial_resources = []
        for resource in mock_resources:
            if plugin._is_potential_spatial_resource(resource):
                spatial_resources.append(resource)
        
        print(f"  üìä Recursos totales: {len(mock_resources)}")
        print(f"  üó∫Ô∏è  Recursos espaciales detectados: {len(spatial_resources)}")
        
        for resource in spatial_resources:
            print(f"    - {resource['format']}: {resource['url']} (ID: {resource['id']})")
        
        # Should find 3 spatial resources (SHP/ZIP, TIF, GEOJSON)
        expected_spatial_count = 3
        success = len(spatial_resources) == expected_spatial_count
        
        print(f"  üéØ Resultado: {'‚úÖ Correcto' if success else '‚ùå Incorrecto'} (esperado: {expected_spatial_count}, obtenido: {len(spatial_resources)})")
        
        # Test specific case: ZIP marked as SHP
        zip_shp_resource = mock_resources[0]  # First resource (ZIP marked as SHP)
        is_spatial = plugin._is_potential_spatial_resource(zip_shp_resource)
        print(f"  üîç Caso especial ZIP->SHP: {'‚úÖ Detectado correctamente' if is_spatial else '‚ùå No detectado'}")
        
        return success and is_spatial
        
    except Exception as e:
        print(f"  ‚ùå Error en simulaci√≥n: {e}")
        return False

def test_format_detection_logic():
    """Prueba espec√≠ficamente la l√≥gica de detecci√≥n de formatos para ZIP/SHP"""
    print("\nüß™ Probando l√≥gica espec√≠fica de detecci√≥n ZIP/SHP...")
    
    try:
        from ckanext.schemingdcat.plugin import SchemingDCATDatasetsPlugin
        
        plugin = SchemingDCATDatasetsPlugin()
        
        test_cases = [
            {
                'description': 'ZIP con shapefile marcado como SHP',
                'resource': {'format': 'SHP', 'url': 'https://storage.azure.com/boundaries.zip'},
                'expected': True
            },
            {
                'description': 'Shapefile directo',
                'resource': {'format': 'SHP', 'url': 'https://storage.azure.com/boundaries.shp'},
                'expected': True
            },
            {
                'description': 'ZIP detectado por extensi√≥n (sin formato)',
                'resource': {'format': '', 'url': 'https://storage.azure.com/data.zip'},
                'expected': True
            },
            {
                'description': 'Archivo normal CSV',
                'resource': {'format': 'CSV', 'url': 'https://storage.azure.com/data.csv'},
                'expected': False
            }
        ]
        
        all_passed = True
        for i, test_case in enumerate(test_cases):
            result = plugin._is_potential_spatial_resource(test_case['resource'])
            expected = test_case['expected']
            status = "‚úÖ" if result == expected else "‚ùå"
            
            print(f"  {status} {test_case['description']}")
            print(f"       {result} (esperado: {expected})")
            
            if result != expected:
                all_passed = False
        
        return all_passed
        
    except Exception as e:
        print(f"  ‚ùå Error en prueba de detecci√≥n: {e}")
        return False

def main():
    """Ejecuta todas las pruebas"""
    print("=" * 80)
    print("üß™ PRUEBAS DE EXTRACCI√ìN ESPACIAL POST-CREACI√ìN DE RECURSOS")
    print("=" * 80)
    print("‚ú® Usando IResourceController para manejar recursos individuales")
    print("üîë Clave: Los ZIP con shapefiles se marcan con formato 'SHP'")
    print("=" * 80)
    
    results = []
    
    # Run tests
    results.append(test_spatial_extent_module_availability())
    results.append(test_resource_controller_integration())
    results.append(test_format_detection_logic())
    results.append(test_is_potential_spatial_resource())
    results.append(test_mock_resource_processing())
    
    # Summary
    print("\n" + "=" * 80)
    print("üìä RESUMEN DE PRUEBAS")
    print("=" * 80)
    
    passed = sum(results)
    total = len(results)
    
    print(f"‚úÖ Pruebas pasadas: {passed}/{total}")
    
    if passed == total:
        print("üéâ ¬°Todas las pruebas pasaron! La implementaci√≥n est√° lista.")
        print("\nüìã PR√ìXIMOS PASOS:")
        print("1. Reiniciar el servidor CKAN para aplicar los cambios")
        print("2. Crear un dataset y agregar un recurso con archivo ZIP")
        print("3. Marcar el formato del recurso como 'SHP' (no 'ZIP')")
        print("4. Guardar el recurso")
        print("5. Verificar que el campo spatial_extent del dataset se llene autom√°ticamente")
        print("6. Revisar los logs para confirmar que la extracci√≥n se ejecuta despu√©s de crear el recurso")
        print("\nüîß FLUJO CORRECTO:")
        print("   Crear recurso ‚Üí Hook after_create de IResourceController ‚Üí Extracci√≥n espacial ‚Üí Actualizar dataset")
    else:
        print("‚ö†Ô∏è  Algunas pruebas fallaron. Revisar la implementaci√≥n.")
    
    print("=" * 80)

if __name__ == "__main__":
    main() 