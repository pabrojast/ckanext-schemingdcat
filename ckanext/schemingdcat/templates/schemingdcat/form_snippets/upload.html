{% import 'macros/form.html' as form %}

{%- set is_upload = data.get((field.upload_field or 'upload')) -%}
{%- set is_url = data.get(field.field_name) and not is_upload -%}
{%- set upload_enabled = h.uploads_enabled() -%}
{%- set field_url = field.field_name -%}
{%- set field_upload = field.upload_field or 'upload' -%}
{%- set field_clear = field.upload_clear or 'clear_upload' -%}

<div class="schemingdcat-upload-wrapper" data-field-url="{{ field_url }}">
  {% if is_upload and data.get('url') %}
    <div class="current-file-info alert alert-info">
      <i class="fa fa-info-circle"></i>
      <strong>{{ _('Current file:') }}</strong> 
      <span class="current-filename">{{ data.get('name', data.get('url', '')) }}</span>
      <label class="checkbox pull-right">
        <input type="checkbox" id="{{ field_clear }}" name="{{ field_clear }}" value="true">
        {{ _('Replace existing file') }}
      </label>
    </div>
  {% endif %}

  {% if upload_enabled %}
    <div class="upload-section">
      <label class="control-label">{{ _('Upload file') }}</label>
      <div class="upload-dropzone" id="dropzone-{{ field_url }}" data-multiple="true">
        <div class="dropzone-content">
          <div class="dropzone-icon">
            <i class="fa fa-cloud-upload"></i>
          </div>
          <h4>{{ _('Drag and drop files here') }}</h4>
          <p class="drop-hint">{{ _('or') }}</p>
          <label for="{{ field_upload }}" class="btn btn-primary browse-button">
            <i class="fa fa-folder-open"></i> {{ _('Browse Files') }}
          </label>
          <input type="file" 
                 id="{{ field_upload }}" 
                 name="{{ field_upload }}" 
                 class="upload-file-input"
                 multiple
                 style="position: absolute; left: -9999px;">
          <p class="text-muted small">
            {{ _('Supported formats: CSV, XLS, JSON, XML, PDF, and more') }}<br>
            <strong>{{ _('Select multiple files to create multiple resources automatically') }}</strong>
          </p>
        </div>

        <div class="file-preview" style="display: none;">
          <div class="file-info">
            <i class="fa fa-file-o fa-2x file-icon"></i>
            <div class="file-details">
              <p class="file-name"></p>
              <p class="file-size text-muted"></p>
            </div>
            <button type="button" class="btn btn-sm btn-danger remove-file">
              <i class="fa fa-times"></i> {{ _('Remove') }}
            </button>
          </div>
          <div class="upload-progress">
            <div class="progress-bar">
              <div class="progress-fill"></div>
            </div>
            <p class="progress-text">{{ _('Processing...') }}</p>
          </div>
        </div>
      </div>
    </div>

    <div class="url-or-separator">
      <span>{{ _('OR') }}</span>
    </div>
  {% endif %}

  <div class="url-section">
    <label class="control-label" for="{{ field_url }}">
      {{ _('Link to a file') }}
    </label>
    <input type="text" 
           id="{{ field_url }}" 
           name="{{ field_url }}" 
           value="{{ data.get(field_url, '') }}"
           placeholder="{{ field.form_placeholder or _('https://example.com/data.csv') }}"
           class="form-control url-input">
  </div>

  {%- snippet 'scheming/form_snippets/help_text.html', field=field -%}
</div>

{% asset 'ckanext-schemingdcat/schemingdcat-modern-upload' %}
<div data-module="schemingdcat-modern-upload"></div>