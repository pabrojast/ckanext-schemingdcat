{% import 'macros/form2.html' as form %}

{# Modern Professional Upload Interface - CSP Compatible #}
<div class="modern-upload-container" id="upload-container-{{ field.field_name }}">
  {# Upload Method Selector (Tabs) #}
  <div class="upload-method-tabs">
    <ul class="nav nav-tabs" role="tablist">
      {% if h.uploads_enabled() %}
        <li class="nav-item">
          <button class="nav-link active" id="upload-tab-{{ field.field_name }}" 
                  data-target="upload-panel-{{ field.field_name }}" type="button"
                  role="tab" aria-controls="upload-panel-{{ field.field_name }}" 
                  aria-selected="true">
            <i class="fa fa-cloud-upload"></i> {{ _('Upload File') }}
          </button>
        </li>
      {% endif %}
      <li class="nav-item">
        <button class="nav-link {% if not h.uploads_enabled() %}active{% endif %}" 
                id="url-tab-{{ field.field_name }}" 
                data-target="url-panel-{{ field.field_name }}" type="button"
                role="tab" aria-controls="url-panel-{{ field.field_name }}" 
                aria-selected="{% if not h.uploads_enabled() %}true{% else %}false{% endif %}">
          <i class="fa fa-link"></i> {{ _('Link to Resource') }}
        </button>
      </li>
    </ul>
  </div>

  <div class="tab-content upload-tab-content">
    {% if h.uploads_enabled() %}
      {# File Upload Panel with Drag & Drop #}
      <div class="tab-pane fade {% if h.uploads_enabled() %}show active{% endif %}" 
           id="upload-panel-{{ field.field_name }}" role="tabpanel" 
           aria-labelledby="upload-tab-{{ field.field_name }}">
        
        {# Drag & Drop Zone #}
        <div class="drag-drop-zone" id="drag-drop-{{ field.field_name }}">
          <div class="drag-drop-content">
            <div class="drag-drop-icon">
              <i class="fa fa-cloud-upload fa-3x"></i>
            </div>
            <h4>{{ _('Drag & Drop your file here') }}</h4>
            <p class="text-muted">{{ _('or click to browse and select a file') }}</p>
            
            {# Hidden File Input #}
            <input type="file" 
                   id="{{ field.upload_field }}" 
                   name="{{ field.upload_field }}"
                   class="file-input-hidden"
                   {% if field.get('form_attrs', {}) %}
                     {% for attr, value in field.form_attrs.items() %}
                       {{ attr }}="{{ value }}"
                     {% endfor %}
                   {% endif %}
            />
            
            {# Upload Button #}
            <button type="button" class="btn btn-primary btn-upload-trigger" 
                    data-target="{{ field.upload_field }}">
              <i class="fa fa-folder-open"></i> {{ _('Choose File') }}
            </button>
          </div>
          
          {# Upload Progress Area (Hidden initially) #}
          <div class="upload-progress-area" style="display: none;">
            <div class="selected-file-info">
              <i class="fa fa-file"></i>
              <span class="file-name"></span>
              <span class="file-size"></span>
            </div>
          </div>
          
          {# Current Upload Display #}
          {% if data[field.field_name] and not data[field.field_name].startswith('http') %}
            <div class="current-upload-display">
              <div class="alert alert-success">
                <i class="fa fa-check-circle"></i>
                <strong>{{ _('Current file') }}:</strong> {{ data[field.field_name] }}
                <button type="button" class="btn btn-sm btn-outline-danger float-right remove-upload-btn"
                        data-clear-field="{{ field.upload_clear }}">
                  <i class="fa fa-times"></i> {{ _('Remove File') }}
                </button>
              </div>
            </div>
          {% endif %}
        </div>
        
        {# Hidden Clear Upload Field #}
        <input type="hidden" name="{{ field.upload_clear }}" value="" />
      </div>
    {% endif %}

    {# URL Panel #}
    <div class="tab-pane fade {% if not h.uploads_enabled() %}show active{% endif %}" 
         id="url-panel-{{ field.field_name }}" role="tabpanel" 
         aria-labelledby="url-tab-{{ field.field_name }}">
      
      <div class="url-input-container">
        <div class="input-group">
          <div class="input-group-prepend">
            <span class="input-group-text">
              <i class="fa fa-link"></i>
            </span>
          </div>
          <input type="url" 
                 id="{{ field.field_name }}" 
                 name="{{ field.field_name }}" 
                 value="{{ data[field.field_name] or '' }}"
                 class="form-control url-input"
                 placeholder="{{ field.form_placeholder or _('https://example.com/data.csv') }}"
                 autocomplete="url"
                 {% if field.get('form_attrs', {}) %}
                   {% for attr, value in field.form_attrs.items() %}
                     {{ attr }}="{{ value }}"
                   {% endfor %}
                 {% endif %}
          />
          <div class="input-group-append">
            <button type="button" class="btn btn-outline-secondary validate-url-btn">
              <i class="fa fa-check"></i> {{ _('Validate') }}
            </button>
          </div>
        </div>
        
        <small class="form-text text-muted">
          <i class="fa fa-info-circle"></i> 
          {{ _('Enter a direct link to your data file (CSV, JSON, XML, etc.)') }}
        </small>
        
        {# URL Validation Feedback #}
        <div class="url-validation-feedback" style="display: none;"></div>
      </div>
    </div>
  </div>

  {# Help Text #}
  {% if field.help_text %}
    <div class="upload-help-text">
      {%- snippet 'scheming/form_snippets/help_text.html', field=field -%}
    </div>
  {% endif %}

  {# Error Display #}
  {% if errors[field.field_name] %}
    <div class="alert alert-danger upload-errors">
      <i class="fa fa-exclamation-triangle"></i>
      {% for error in errors[field.field_name] %}
        <div>{{ error }}</div>
      {% endfor %}
    </div>
  {% endif %}
</div>

{# Simple CSP-Compatible JavaScript #}
<script>
(function() {
    "use strict";
    
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeUpload);
    } else {
        initializeUpload();
    }
    
    function initializeUpload() {
        // Get container
        var containerElement = document.getElementById('upload-container-{{ field.field_name }}');
        if (!containerElement) {
            return;
        }
        
        // Initialize tab functionality
        initializeTabs(containerElement);
        
        // Initialize drag and drop if available
        initializeDragAndDrop(containerElement);
        
        // Initialize URL validation
        initializeUrlValidation(containerElement);
        
        // Initialize clear upload functionality
        initializeClearUpload(containerElement);
    }
    
    function initializeTabs(container) {
        var tabButtons = container.querySelectorAll('.nav-link');
        var tabPanes = container.querySelectorAll('.tab-pane');
        
        // Add click handlers to tab buttons
        Array.prototype.forEach.call(tabButtons, function(button) {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                
                var targetId = this.getAttribute('data-target');
                var targetPane = document.getElementById(targetId);
                
                if (!targetPane) {
                    return;
                }
                
                // Hide all panes
                Array.prototype.forEach.call(tabPanes, function(pane) {
                    pane.classList.remove('show', 'active');
                    pane.style.display = 'none';
                });
                
                // Remove active from all tabs
                Array.prototype.forEach.call(tabButtons, function(btn) {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-selected', 'false');
                });
                
                // Show target pane
                targetPane.style.display = 'block';
                targetPane.classList.add('show', 'active');
                
                // Mark this tab as active
                this.classList.add('active');
                this.setAttribute('aria-selected', 'true');
            });
        });
    }
    
    function initializeDragAndDrop(container) {
        var dragZone = container.querySelector('.drag-drop-zone');
        var fileInput = container.querySelector('input[type="file"]');
        var uploadBtn = container.querySelector('.btn-upload-trigger');
        
        if (!dragZone || !fileInput) {
            return;
        }
        
        // Drag events
        dragZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });
        
        dragZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
        });
        
        dragZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            var files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelection(files[0], container);
            }
        });
        
        // Click to upload
        if (uploadBtn) {
            uploadBtn.addEventListener('click', function() {
                fileInput.click();
            });
        }
        
        // File input change
        fileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                handleFileSelection(this.files[0], container);
            }
        });
    }
    
    function initializeUrlValidation(container) {
        var validateBtn = container.querySelector('.validate-url-btn');
        var urlInput = container.querySelector('.url-input');
        
        if (!validateBtn || !urlInput) {
            return;
        }
        
        validateBtn.addEventListener('click', function() {
            var url = urlInput.value.trim();
            var feedback = container.querySelector('.url-validation-feedback');
            
            if (!url) {
                showUrlFeedback(feedback, 'Please enter a URL', 'error');
                return;
            }
            
            if (!isValidUrl(url)) {
                showUrlFeedback(feedback, 'Please enter a valid URL', 'error');
                return;
            }
            
            showUrlFeedback(feedback, 'URL appears valid', 'success');
            
            // Try to detect format from URL
            var extension = getExtensionFromUrl(url);
            if (extension) {
                var formatField = document.querySelector('input[name="format"], #field-format');
                if (formatField && !formatField.value) {
                    formatField.value = getFormatFromExtension(extension);
                }
            }
        });
        
        // Auto-validate on input change
        urlInput.addEventListener('input', function() {
            var feedback = container.querySelector('.url-validation-feedback');
            if (feedback) {
                feedback.style.display = 'none';
            }
        });
    }
    
    function initializeClearUpload(container) {
        var clearBtn = container.querySelector('.remove-upload-btn');
        
        if (!clearBtn) {
            return;
        }
        
        clearBtn.addEventListener('click', function() {
            var clearField = clearBtn.getAttribute('data-clear-field');
            var clearInput = document.querySelector('input[name="' + clearField + '"]');
            
            if (clearInput) {
                clearInput.value = '1';
            }
            
            var currentDisplay = container.querySelector('.current-upload-display');
            if (currentDisplay) {
                currentDisplay.style.display = 'none';
            }
        });
    }
    
    function handleFileSelection(file, container) {
        var progressArea = container.querySelector('.upload-progress-area');
        var dragContent = container.querySelector('.drag-drop-content');
        
        if (progressArea && dragContent) {
            var fileNameSpan = progressArea.querySelector('.file-name');
            var fileSizeSpan = progressArea.querySelector('.file-size');
            
            if (fileNameSpan) {
                fileNameSpan.textContent = file.name;
            }
            if (fileSizeSpan) {
                fileSizeSpan.textContent = formatFileSize(file.size);
            }
            
            dragContent.style.display = 'none';
            progressArea.style.display = 'block';
        }
        
        // Auto-populate fields
        autoPopulateFields(file);
    }
    
    function autoPopulateFields(file) {
        var fileName = file.name;
        var cleanName = fileName.replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' ');
        var extension = fileName.split('.').pop().toLowerCase();
        var today = new Date().toISOString().split('T')[0];
        
        // Name field
        var nameField = document.querySelector('input[name="name"], #field-name');
        if (nameField && !nameField.value) {
            nameField.value = cleanName;
        }
        
        // Format field
        var formatField = document.querySelector('input[name="format"], #field-format');
        if (formatField && !formatField.value) {
            var format = getFormatFromExtension(extension);
            formatField.value = format;
        }
        
        // Date field
        var dateField = document.querySelector('input[name="created"], #field-created');
        if (dateField && !dateField.value) {
            dateField.value = today;
        }
        
        // Description field
        var descField = document.querySelector('textarea[name="description"], #field-description');
        if (descField && !descField.value) {
            descField.value = 'File uploaded: ' + fileName;
        }
    }
    
    function getFormatFromExtension(ext) {
        var formats = {
            'csv': 'CSV',
            'json': 'JSON',
            'geojson': 'GeoJSON',
            'xml': 'XML',
            'xlsx': 'XLSX',
            'xls': 'XLS',
            'pdf': 'PDF',
            'txt': 'TXT',
            'zip': 'ZIP',
            'rar': 'RAR',
            'kml': 'KML',
            'kmz': 'KMZ',
            'shp': 'SHP',
            'gpx': 'GPX',
            'png': 'PNG',
            'jpg': 'JPG',
            'jpeg': 'JPEG',
            'gif': 'GIF',
            'mp4': 'MP4',
            'mp3': 'MP3',
            'wav': 'WAV',
            'doc': 'DOC',
            'docx': 'DOCX',
            'ppt': 'PPT',
            'pptx': 'PPTX',
            'html': 'HTML',
            'htm': 'HTML',
            'rdf': 'RDF',
            'ttl': 'TTL',
            'n3': 'N3',
            'nt': 'NT',
            'owl': 'OWL',
            'jsonld': 'JSON-LD',
            'tiff': 'TIFF',
            'tif': 'TIFF',
            'svg': 'SVG',
            'wkt': 'WKT',
            'wkb': 'WKB',
            'gml': 'GML',
            'api': 'API',
            'rest': 'REST',
            'soap': 'SOAP',
            'wms': 'WMS',
            'wfs': 'WFS',
            'wcs': 'WCS',
            'wmts': 'WMTS'
        };
        
        return formats[ext] || ext.toUpperCase();
    }
    
    function getExtensionFromUrl(url) {
        var pathname = url.split('?')[0];
        var parts = pathname.split('.');
        return parts.length > 1 ? parts[parts.length - 1].toLowerCase() : null;
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        var k = 1024;
        var sizes = ['Bytes', 'KB', 'MB', 'GB'];
        var i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function isValidUrl(string) {
        try {
            var url = new URL(string);
            return url.protocol === 'http:' || url.protocol === 'https:';
        } catch (e) {
            return false;
        }
    }
    
    function showUrlFeedback(element, message, type) {
        if (!element) return;
        
        element.textContent = message;
        element.className = 'url-validation-feedback alert alert-' + (type === 'error' ? 'danger' : 'success');
        element.style.display = 'block';
    }
    
})();
</script>