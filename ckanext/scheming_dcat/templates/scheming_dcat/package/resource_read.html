{% extends "package/resource_read.html" %}

{%  set exclude_fields = [
  'name',
  'description',
  'url',
  'format',
  'rights',
  'license',
  'size'
  ] %}

  {# Fields for snippet scheming_dcat/package/snippets/resource_extended_info.html #}
  {% set extended_fields = [
    'modified',
    'created',
    'conforms_to',
    'language',
    'mimetype',
    'reference_system'
    ]
  %}

{%  set schema = h.scheming_get_dataset_schema(dataset_type) %}

{% block resource_actions_inner %}
  {% block action_manage %}
    {% if h.check_access('package_update', {'id':pkg.id }) %}
      <li>{% link_for _('Edit resource'), named_route=pkg.type ~ '_resource.edit', id=pkg.name, resource_id=res.id, class_='btn btn-default', icon='pencil' %}</li>
      {% block action_manage_inner %}{% endblock %}
      <li>{% link_for _('Views'), named_route=pkg.type ~ '_resource.views', id=pkg.name, resource_id=res.id, class_='btn btn-default', icon='chart-bar' %}
    {% endif %}
  {% endblock action_manage %}
{% if res.url and h.is_url(res.url) %}
<li>
  <div class="btn-group">
  <a class="btn btn-primary resource-url-analytics" href="{{ res.url }}">
    {% if res.resource_type in ('listing', 'service') %}
      <i class="fa fa-eye"></i> {{ _('View') }}
    {% elif res.resource_type == 'api' %}
      <i class="fa fa-key"></i> {{ _('API Endpoint') }}
    {% elif res.has_views and not res.url_type == 'upload' %}
      <i class="fa fa-external-link"></i> {{ _('Go to resource') }}
    {% elif not res.has_views and res.url_type == 'upload' %}
      <i class="fa fa-arrow-circle-down"></i> {{ _('Download') }}
    {% else %}
      <i class="fa fa-external-link"></i> {{ _('Go to resource') }}
    {% endif %}
  </a>
  {% block download_resource_button %}
    {% if res.datastore_active and res.url_type == 'datastore' %}
      <button class="btn btn-primary dropdown-toggle" role="button" id="dropdownDownloadFormat" data-bs-toggle="dropdown" aria-expanded="false" aria-label="list of downloadable formats">
          <span class="caret"></span>
        </button>
      <ul class="dropdown-menu" aria-labelledby="dropdownDownloadFormat">
        <li>
          <a class="dropdown-item" href="{{ h.url_for('datastore.dump', resource_id=res.id, bom=True) }}"
            target="_blank" rel="noreferrer"><span>CSV</span></a>
        </li>
        <li>
          <a class="dropdown-item" href="{{ h.url_for('datastore.dump', resource_id=res.id, format='tsv', bom=True) }}"
            target="_blank" rel="noreferrer"><span>TSV</span></a>
        </li>
        <li>
            <a class="dropdown-item" href="{{ h.url_for('datastore.dump', resource_id=res.id, format='json') }}"
            target="_blank" rel="noreferrer"><span>JSON</span></a>
        </li>
        <li>
            <a class="dropdown-item" href="{{ h.url_for('datastore.dump', resource_id=res.id, format='xml') }}"
            target="_blank" rel="noreferrer"><span>XML</span></a>
        </li>
      </ul>
        {% endif %}
  {% endblock %}
  </div>
</li>
{% endif %}
{% endblock %}

{% block resource_additional_information_inner %}
  {% if not res.datastore_active and res.url_type == 'datastore' %}
  {% block resource_data_dictionary %}
    <div class="module-content">
      <h2>{{ _('Data Dictionary') }}</h2>
      <table class="table table-striped table-bordered table-condensed" data-module="table-toggle-more">
        <thead>
          {% block resouce_data_dictionary_headers %}
          <tr>
            <th scope="col">{{ _('Column') }}</th>
            <th scope="col">{{ _('Type') }}</th>
            <th scope="col">{{ _('Label') }}</th>
            <th scope="col">{{ _('Description') }}</th>
          </tr>
          {% endblock %}
        </thead>
        {% block resource_data_dictionary_data %}
          {% set dict=h.datastore_dictionary(res.id) %}
          {% for field in dict %}
            {% snippet "package/snippets/dictionary_table.html", field=field %}
          {% endfor %}
        {% endblock %}
      </table>
    </div>
  {% endblock %}
  {% endif %}

  <div class="module-content">
    {%  block additional_info_heading %}<h2>{{ _('Additional information') }}</h2>{%  endblock %}
    <table class="table table-striped table-bordered table-condensed" data-module="table-toggle-more">
      {%  block additional_info_table_head %}
        <thead>
          <tr>
            <th scope="col">{{ _('Field') }}</th>
            <th scope="col">{{ _('Value') }}</th>
          </tr>
        </thead>
      {%  endblock %}
      <tbody>
        {% block extended_info %}
          {% snippet "scheming_dcat/package/snippets/resource_extended_info.html", field=field, res=res, extended_fields=extended_fields, schema=schema %}
        {% endblock %}
        
        {%  block resource_fields %}
          {%  for field in schema.resource_fields %}
            {%  if field.field_name not in exclude_fields
                and field.field_name not in extended_fields
                and field.display_snippet is not none %}
                  <tr>
                    <th scope="row">{{ h.scheming_language_text(field.label) }}</th>
                    <td class="dataset-details"{%
                      if field.display_property %} property="{{ field.display_property
                      }}"{% endif %}>{%  snippet 'scheming/snippets/display_field.html',
                      field=field, data=res, schema=schema %}</td>
                  </tr>
            {% endif %}
          {% endfor %}
        {% endblock %}
      </tbody>
    </table>


  </div>
{% endblock %}

{% block secondary_content %}

  {% block resources_list %}
    {% snippet "package/snippets/resources.html", pkg=pkg, active=res.id, action='read' %}
  {% endblock %}

  {% block resource_license %}
    {% snippet "scheming_dcat/snippets/schemingdct_license.html", pkg_dict=pkg %}
  {% endblock %}
{% endblock %}